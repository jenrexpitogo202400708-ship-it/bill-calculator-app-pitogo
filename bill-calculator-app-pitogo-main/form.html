<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form - Electric Bill Calculator</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Load Supabase scripts FIRST -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase_config.js"></script>
  <script src="js/auth.js"></script>
</head>

<body style="background-color: #E2BCBC;">

<div class="phone">
  <h2 class="title">Electric Bill Calculator</h2>
  <div class="logo">⚡</div>

  <form id="signupForm">

    <div class="input-box">
      <input id="admin" type="text" placeholder="Admin ID">
    </div>

    <div class="input-box">
      <input id="name" type="text" placeholder="Name">
    </div>

    <div class="input-box">
      <input id="address" type="text" placeholder="Address">
    </div>

    <div class="input-box">
      <input id="contact" type="number" placeholder="Contact number">
    </div>

    <div class="input-box">
      <input id="email" type="email" placeholder="Email">
    </div>

    <div class="input-box">
      <input id="password" type="password" placeholder="Password">
    </div>

    <div class="button">
      <button type="submit">Confirm</button>
    </div>

  </form>

  <div id="signupMessage" style="margin-top:12px;color:#222;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // NOTE: do not auto-redirect from the registration form.
  // We want users to land on this form when they click "Get Started",
  // even if they have an active session in the browser.

  const form = document.getElementById('signupForm');
  const msgEl = document.getElementById('signupMessage');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const name = document.getElementById('name').value.trim();
    const admin = document.getElementById('admin').value.trim();
    const address = document.getElementById('address').value.trim();
    const contact = document.getElementById('contact').value.trim();

    // Validation
    if (!email || !password || !name) {
      msgEl.textContent = 'Please fill in Email, Password, and Name.';
      msgEl.style.color = 'red';
      return;
    }

    if (password.length < 6) {
      msgEl.textContent = 'Password must be at least 6 characters.';
      msgEl.style.color = 'red';
      return;
    }

    msgEl.textContent = 'Creating account...';
    msgEl.style.color = '#333';

    // Register with Supabase
    // Use the configured site URL (falls back to http://localhost:5500 in dev)
    const redirectTo = (window.siteUrl || window.location.origin || 'http://localhost:5500') + '/auth-confirmed.html';
    const { data, error } = await supabaseClient.auth.signUp({
      email: email,
      password: password,
      options: {
        emailRedirectTo: redirectTo,
        data: {
          full_name: name,
          admin_id: admin,
          address: address,
          contact: contact
        }
      }
    });

    if (error) {
      console.error('Registration error:', error);
      msgEl.textContent = 'Registration failed: ' + (error.message || 'Unknown error');
      msgEl.style.color = 'red';
      return;
    }

    // Clear form and instruct user to confirm email
    form.reset();
    msgEl.textContent = 'Account created successfully! A confirmation email has been sent — please check your inbox and click the confirmation link before you log in.';
    msgEl.style.color = 'green';
    // Do not auto-redirect to login. The confirmation landing page (`auth-confirmed.html`) will
    // redirect users to `login.html` after they click the link in their email.
  });
});
</script>

</body>
</html>
