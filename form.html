<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator - Electric Bill Calculator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1 class="nav-title">⚡ Electric Bill Calculator</h1>
            <div class="nav-links">
                <a href="user_dashboard.html" class="nav-link">Dashboard</a>
                <a href="form.html" class="nav-link active">Calculator</a>
                <a href="history.html" class="nav-link">History</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <button class="nav-link btn-danger" onclick="handleLogout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="calculator-container">
            <h1>Electric Bill Calculator</h1>
            <form id="calculatorForm">
                <div class="form-group">
                    <label for="month">Month/Period</label>
                    <input type="text" id="month" name="month" required placeholder="e.g., January 2024" value="">
                </div>
                <div class="form-group">
                    <label for="power_consumption">Power Consumption (kWh)</label>
                    <input type="number" id="power_consumption" name="power_consumption" required placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="cost_per_kwh">Cost per kWh (₱)</label>
                    <input type="number" id="cost_per_kwh" name="cost_per_kwh" required placeholder="0.00" step="0.01">
                </div>
                <button type="button" class="btn-primary" onclick="handleCalculate()">Calculate Bill</button>
            </form>

            <div id="resultDiv" class="result-section" style="display:none;">
                <h2>Calculation Result</h2>
                <div class="result-display">
                    <p>Your electric bill is: <strong>₱ <span id="resultAmount">0.00</span></strong></p>
                </div>
            </div>

            <div id="message" class="message"></div>

            <h2>Your Recent Calculations</h2>
            <table id="calculationsTable" class="calculations-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Power Consumption (kWh)</th>
                        <th>Cost per kWh (₱)</th>
                        <th>Total Bill (₱)</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Electric Bill Calculator. All rights reserved.</p>
    </footer>

    <!-- Supabase scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Set today's date in month field
        function setCurrentMonth() {
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const monthYear = monthNames[now.getMonth()] + " " + now.getFullYear();
            document.getElementById("month").value = monthYear;
        }

        // Check authentication on page load
        document.addEventListener("DOMContentLoaded", async () => {
            const session = await initAuth();
            if (session) {
                setCurrentMonth();
                await loadCalculations();
            }
        });

        async function handleCalculate() {
            const month = document.getElementById("month").value.trim();
            const powerConsumption = parseFloat(document.getElementById("power_consumption").value);
            const costPerKwh = parseFloat(document.getElementById("cost_per_kwh").value);
            const messageDiv = document.getElementById("message");

            // Validation
            if (!month || !powerConsumption || !costPerKwh) {
                messageDiv.className = "message error";
                messageDiv.textContent = "Please fill in all fields!";
                return;
            }

            if (powerConsumption <= 0 || costPerKwh <= 0) {
                messageDiv.className = "message error";
                messageDiv.textContent = "Power consumption and cost must be greater than 0!";
                return;
            }

            // Get current user
            const user = await getCurrentUser();
            if (!user) {
                messageDiv.className = "message error";
                messageDiv.textContent = "You must be logged in!";
                return;
            }

            // Calculate result
            const result = powerConsumption * costPerKwh;

            // Save to Supabase
            const { data, error } = await supabaseClient
                .from("calculations")
                .insert([
                    {
                        user_id: user.id,
                        month: month,
                        power_consumption: powerConsumption,
                        cost_per_kwh: costPerKwh,
                        result: result
                    }
                ])
                .select();

            if (error) {
                messageDiv.className = "message error";
                messageDiv.textContent = "Failed to save: " + error.message;
                console.error("Save error:", error);
                return;
            }

            // Display result
            document.getElementById("resultAmount").textContent = result.toFixed(2);
            document.getElementById("resultDiv").style.display = "block";

            messageDiv.className = "message success";
            messageDiv.textContent = "Calculation saved successfully!";

            // Clear form
            document.getElementById("calculatorForm").reset();
            setCurrentMonth();

            // Reload calculations table
            await loadCalculations();
        }

        async function loadCalculations() {
            const user = await getCurrentUser();
            if (!user) return;

            const { data, error } = await supabaseClient
                .from("calculations")
                .select("*")
                .eq("user_id", user.id)
                .order("created_at", { ascending: false });

            if (error) {
                console.error("Load error:", error);
                return;
            }

            const tbody = document.querySelector("#calculationsTable tbody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No calculations yet. Create your first one!</td></tr>';
                return;
            }

            data.forEach(calc => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${calc.month}</td>
                    <td>${parseFloat(calc.power_consumption).toFixed(2)}</td>
                    <td>${parseFloat(calc.cost_per_kwh).toFixed(2)}</td>
                    <td>${parseFloat(calc.result).toFixed(2)}</td>
                    <td>${new Date(calc.created_at).toLocaleDateString()}</td>
                `;
            });
        }

        async function handleLogout() {
            const success = await signOut();
            if (success) {
                window.location.href = "login.html";
            } else {
                alert("Failed to logout");
            }
        }
    </script>
</body>
</html>
